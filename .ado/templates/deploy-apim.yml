parameters:
  - name: environment
    type: string
    values:
      - dev
      - staging
      - prod
  - name: azureSubscription
    type: string
  - name: workingDirectory
    type: string
    default: "apim/terraform"
  - name: terraformVersion
    type: string
    default: "1.13.3"

steps:
  - checkout: self
    displayName: "Checkout Source Code"

  - task: DownloadPipelineArtifact@2
    displayName: "Download Build Artifact"
    inputs:
      buildType: "current"
      artifactName: "drop"
      targetPath: "$(Pipeline.Workspace)/drop"

  - task: TerraformInstaller@0
    displayName: "Install Terraform"
    inputs:
      terraformVersion: ${{ parameters.terraformVersion }}

  - task: AzureCLI@2
    displayName: "Get Function App Key"
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: "bash"
      scriptLocation: "inlineScript"
      inlineScript: |
        echo "Retrieving Function App key for APIM backend configuration..."

        FUNCTION_APP_NAME="$(FUNCTION_APP_NAME)"
        RESOURCE_GROUP="$(APIM_RESOURCE_GROUP)"

        # Get the default function key
        FUNCTION_KEY=$(az functionapp keys list \
          --name "$FUNCTION_APP_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --query "functionKeys.default" \
          --output tsv)

        if [ -z "$FUNCTION_KEY" ]; then
          echo "✗ Failed to retrieve function key"
          exit 1
        fi

        echo "✓ Function key retrieved successfully"
        echo "##vso[task.setvariable variable=FUNCTION_APP_KEY;issecret=true]$FUNCTION_KEY"
        echo "##vso[task.setvariable variable=TF_VAR_function_app_key;issecret=true]$FUNCTION_KEY"

  - task: AzureCLI@2
    displayName: "Terraform Init"
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: "bash"
      scriptLocation: "inlineScript"
      workingDirectory: "${{ parameters.workingDirectory }}"
      inlineScript: |
        set -euo pipefail

        echo "Initializing Terraform for APIM configuration..."

        terraform init \
          -backend-config="resource_group_name=$(TF_STATE_RESOURCE_GROUP)" \
          -backend-config="storage_account_name=$(TF_STATE_STORAGE_ACCOUNT)" \
          -backend-config="container_name=$(TF_STATE_CONTAINER)" \
          -backend-config="key=apim/${{ parameters.environment }}/terraform.tfstate"

        echo "Terraform initialization complete"

  - task: AzureCLI@2
    displayName: "Terraform Validate"
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: "bash"
      scriptLocation: "inlineScript"
      workingDirectory: "${{ parameters.workingDirectory }}"
      inlineScript: |
        echo "Validating Terraform configuration..."
        terraform validate
        echo "Validation complete"

  - task: AzureCLI@2
    displayName: "Terraform Plan"
    env:
      FUNCTION_APP_KEY: $(FUNCTION_APP_KEY)
      TF_VAR_function_app_key: $(TF_VAR_function_app_key)
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: "bash"
      scriptLocation: "inlineScript"
      workingDirectory: "${{ parameters.workingDirectory }}"
      inlineScript: |
        echo "Generating Terraform execution plan for APIM APIs and policies..."
        echo ""
        echo "Environment: ${{ parameters.environment }}"
        echo "APIM Instance: ${APIM_NAME}"
        echo "Resource Group: ${APIM_RESOURCE_GROUP}"
        echo "Function App: ${FUNCTION_APP_NAME}"
        echo ""

        set -euo pipefail

        : "${FUNCTION_APP_KEY:?FUNCTION_APP_KEY not set}"

        append_tf_var() {
          local name="$1"
          local value="$2"

          # Trim leading/trailing whitespace
          value="$(echo "$value" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"

          # Ignore unset Azure Pipeline variables (rendered as $(VAR_NAME)) or empty values
          if [[ -z "$value" || "$value" =~ ^\$\(.+\)$ ]]; then
            return
          fi

          TF_PLAN_ARGS+=("-var=${name}=${value}")
        }

        TF_PLAN_ARGS=(
          "-var=environment=${{ parameters.environment }}"
          "-var=api_management_name=${APIM_NAME}"
          "-var=resource_group_name=${APIM_RESOURCE_GROUP}"
          "-var=function_app_name=${FUNCTION_APP_NAME}"
          "-var=function_app_key=${FUNCTION_APP_KEY}"
        )

        VAR_FILES=()

        # Ensure we do not reuse a stale override file between runs
        trap 'rm -f cors-origins.auto.tfvars.json' EXIT
        rm -f cors-origins.auto.tfvars.json

        # Get CORS origins from pipeline variable
        CORS_ORIGINS_RAW="${APIM_CORS_ORIGINS:-}"

        if [ -n "$CORS_ORIGINS_RAW" ]; then
          echo "Using custom CORS origins override supplied by pipeline variable"
          echo "DEBUG: Raw CORS value: [$CORS_ORIGINS_RAW]"

          # Check if already JSON array format
          if [[ "$CORS_ORIGINS_RAW" =~ ^\[.*\]$ ]]; then
            echo "DEBUG: Detected JSON array format"
            ORIGINS_JSON="$CORS_ORIGINS_RAW"
          else
            echo "DEBUG: Converting comma-separated string to JSON array"
            
            # Remove any newlines and carriage returns
            CORS_ORIGINS_SANITIZED="${CORS_ORIGINS_RAW//$'\n'/,}"
            CORS_ORIGINS_SANITIZED="${CORS_ORIGINS_SANITIZED//$'\r'/}"
            
            # Split by comma and build JSON array
            IFS=',' read -ra ORIGIN_ITEMS <<< "$CORS_ORIGINS_SANITIZED"
            ORIGINS_JSON="["
            FIRST_ITEM=1
            
            for ITEM in "${ORIGIN_ITEMS[@]}"; do
              # Trim whitespace
              TRIMMED_ITEM="$(echo "$ITEM" | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')"
              
              # Skip empty items
              if [ -z "$TRIMMED_ITEM" ]; then
                continue
              fi
              
              # Add comma if not first item
              if [ $FIRST_ITEM -eq 1 ]; then
                ORIGINS_JSON+="\"$TRIMMED_ITEM\""
                FIRST_ITEM=0
              else
                ORIGINS_JSON+=", \"$TRIMMED_ITEM\""
              fi
            done
            ORIGINS_JSON+="]"
          fi

          echo "DEBUG: Generated JSON: $ORIGINS_JSON"

          # Write the JSON file with proper formatting
          cat <<'JSONEOF' > cors-origins.auto.tfvars.json
          {
            "cors_origins": CORS_PLACEHOLDER
          }
        JSONEOF

          # Replace placeholder with actual JSON array
          sed -i "s|CORS_PLACEHOLDER|$ORIGINS_JSON|g" cors-origins.auto.tfvars.json

          echo "DEBUG: Contents of cors-origins.auto.tfvars.json:"
          cat cors-origins.auto.tfvars.json
          
          # Validate the JSON file
          if ! jq empty cors-origins.auto.tfvars.json 2>/dev/null; then
            echo "✗ ERROR: Generated JSON is invalid!"
            echo "DEBUG: Attempting to show JSON content:"
            cat cors-origins.auto.tfvars.json || echo "Could not read file"
            exit 1
          fi
          
          echo "✓ JSON validation passed"
          VAR_FILES+=("-var-file=cors-origins.auto.tfvars.json")
        else
          echo "No custom CORS origins supplied; Terraform defaults will be used"
        fi

        append_tf_var "api_version" "${APIM_API_VERSION:-}"
        append_tf_var "rate_limit_calls" "${APIM_RATE_LIMIT_CALLS:-}"
        append_tf_var "rate_limit_period" "${APIM_RATE_LIMIT_PERIOD:-}"
        append_tf_var "cache_duration_sets" "${APIM_CACHE_DURATION_SETS:-}"
        append_tf_var "cache_duration_cards" "${APIM_CACHE_DURATION_CARDS:-}"
        append_tf_var "cache_duration_card_info" "${APIM_CACHE_DURATION_CARD_INFO:-}"
        append_tf_var "backend_timeout" "${APIM_BACKEND_TIMEOUT:-}"

        # Run Terraform plan
        EXIT_CODE=0
        terraform plan \
          "${TF_PLAN_ARGS[@]}" \
          "${VAR_FILES[@]}" \
          -out=tfplan \
          -detailed-exitcode || EXIT_CODE=$?

        # Exit codes: 0 = no changes, 1 = error, 2 = changes present
        if [ "${EXIT_CODE}" == "1" ]; then
          echo "✗ Terraform plan failed"
          exit 1
        elif [ "${EXIT_CODE}" == "2" ]; then
          echo "✓ Changes detected - plan generated"
          echo "##vso[task.setvariable variable=HasChanges;isOutput=true]true"
        else
          echo "✓ No changes detected"
          echo "##vso[task.setvariable variable=HasChanges;isOutput=true]false"
        fi

  - task: AzureCLI@2
    displayName: "Terraform Apply"
    env:
      TF_VAR_function_app_key: $(TF_VAR_function_app_key)
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: "bash"
      scriptLocation: "inlineScript"
      workingDirectory: "${{ parameters.workingDirectory }}"
      inlineScript: |
        set -euo pipefail

        echo "Applying APIM API and policy configuration..."
        echo ""

        terraform apply -auto-approve tfplan

        echo ""
        echo "✓ APIM configuration applied successfully"

  - task: AzureCLI@2
    displayName: "Verify APIM Configuration"
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: "bash"
      scriptLocation: "inlineScript"
      inlineScript: |
        set -euo pipefail

        echo "Verifying APIM configuration..."

        APIM_NAME="$(APIM_NAME)"
        RESOURCE_GROUP="$(APIM_RESOURCE_GROUP)"
        API_NAME="pcpc-api-${{ parameters.environment }}"
        SUBSCRIPTION_ID=$(az account show --query id -o tsv)

        # Verify APIM instance exists
        if az apim show --name "$APIM_NAME" --resource-group "$RESOURCE_GROUP" &>/dev/null; then
          echo "✓ APIM instance exists: $APIM_NAME"
        else
          echo "✗ APIM instance not found: $APIM_NAME"
          exit 1
        fi

        # Verify API exists
        if az apim api show \
          --api-id "$API_NAME" \
          --service-name "$APIM_NAME" \
          --resource-group "$RESOURCE_GROUP" &>/dev/null; then
          echo "✓ API exists: $API_NAME"
        else
          echo "✗ API not found: $API_NAME"
          exit 1
        fi

        # Get API operations count
        OPERATIONS_COUNT=$(az apim api operation list \
          --api-id "$API_NAME" \
          --service-name "$APIM_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --query "length(@)" \
          --output tsv)

        echo "✓ API has $OPERATIONS_COUNT operations configured"

        # Verify backend exists using REST API
        BACKEND_NAME="pcpc-function-backend-${{ parameters.environment }}"
        echo "Checking backend: $BACKEND_NAME"
        
        BACKEND_RESPONSE=$(az rest --method get \
          --url "https://management.azure.com/subscriptions/${SUBSCRIPTION_ID}/resourceGroups/${RESOURCE_GROUP}/providers/Microsoft.ApiManagement/service/${APIM_NAME}/backends/${BACKEND_NAME}?api-version=2024-05-01" \
          2>&1)
        
        if [ $? -eq 0 ]; then
          BACKEND_URL=$(echo "$BACKEND_RESPONSE" | jq -r '.properties.url')
          echo "✓ Backend exists: $BACKEND_NAME"
          echo "  Backend URL: $BACKEND_URL"
        else
          echo "✗ Backend not found: $BACKEND_NAME"
          echo "  Error: $BACKEND_RESPONSE"
          exit 1
        fi

        echo ""
        echo "APIM configuration verification complete"

  - task: AzureCLI@2
    displayName: "Get APIM Gateway URL"
    inputs:
      azureSubscription: ${{ parameters.azureSubscription }}
      scriptType: "bash"
      scriptLocation: "inlineScript"
      inlineScript: |
        echo "Retrieving APIM gateway URL..."

        APIM_NAME="$(APIM_NAME)"
        RESOURCE_GROUP="$(APIM_RESOURCE_GROUP)"

        GATEWAY_URL=$(az apim show \
          --name "$APIM_NAME" \
          --resource-group "$RESOURCE_GROUP" \
          --query "gatewayUrl" \
          --output tsv)

        if [ -z "$GATEWAY_URL" ]; then
          echo "✗ Failed to retrieve gateway URL"
          exit 1
        fi

        echo "✓ APIM Gateway URL: $GATEWAY_URL"
        echo "##vso[task.setvariable variable=APIM_GATEWAY_URL;isOutput=true]$GATEWAY_URL"

  - script: |
      echo ""
      echo "=========================================="
      echo "APIM Deployment Summary"
      echo "=========================================="
      echo "Environment: ${{ upper(parameters.environment) }}"
      echo "APIM Instance: $(APIM_NAME)"
      echo "Resource Group: $(APIM_RESOURCE_GROUP)"
      echo "API Name: pcpc-api-${{ parameters.environment }}"
      echo "Gateway URL: $(APIM_GATEWAY_URL)"
      echo "Backend: $(FUNCTION_APP_NAME)"
      echo ""
      echo "Deployed Components:"
      echo "  ✓ API Definition (OpenAPI spec)"
      echo "  ✓ API Operations (3 endpoints)"
      echo "  ✓ Backend Configuration (Azure Functions)"
      echo "  ✓ Global Policies (CORS, rate limiting)"
      echo "  ✓ Operation Policies (caching, routing)"
      echo "=========================================="
      echo ""
    displayName: "Display Deployment Summary"
